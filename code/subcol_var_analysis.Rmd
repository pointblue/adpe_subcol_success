---
title: "Analysis of variation in reproductive success by subcolony"
author: "Annie Schmidt"
date: "June 2, 2016"
output:
  pdf_document: default
  html_document: default
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

```{r load libraries and data}
library(ggplot2)
library(dplyr)
library(readr)
library(mgcv)
library(bbmle)
library(dismo)
library(gbm)

#Set working directory
setwd("Z:/Informatics/S031/analyses/aschmidt/subcol_var")

  
# Define functions #### 
# correlation matrix of data
panel.cor <- function(x, y, digits = 2, prefix = "", cex.cor, ...){
    usr <- par("usr"); on.exit(par(usr))
    par(usr = c(0, 1, 0, 1))
    r <- abs(cor(x, y, use="complete.obs"))
    txt <- format(c(r, 0.123456789), digits = digits)[1]
    txt <- paste0(prefix, txt)
    if(missing(cex.cor)) cex.cor <- 0.8/strwidth(txt)
    text(0.5, 0.5, txt, cex = cex.cor * r)
}


# read in data files ####
ct_meas <- read_csv("Z:/Informatics/S031/analyses/aschmidt/subcol_var/data/croz_selected_meas_ct_all.csv")
spec(ct_meas)
# select only years 1415-1718
ct_meas_sub <- ct_meas%>%
  filter(season%in%c("1415", "1516","1617","1718"))
# Area and perimeter highly correlated
# Also wind and solar
```


First modeling attempts
```{r first modeling attempts, echo = FALSE}
# select columns for analysis
# calculate aspect categories####
dat <- ct_meas_sub%>%
  dplyr::select(season,area_name, subcol,active_ct,prod,ann_prod_anom,prod_anom,area,perim,pa_ratio,mean_slope,mean_aspect,adjust_mean_elev, mean_elev,mean_wind,mean_solar,flood_risk,skua50,skua100, col_side)%>%
  mutate(season=factor(season),subcol=factor(subcol),col_side=factor(col_side), aspect_cat =factor(findInterval(mean_aspect,c(0,22,45,67,90,112,135,157,180,202,225,247,270,292,315,337,360))))%>%
  # mutate(aspect_cat=factor(plyr::mapvalues(aspect_cat, from = c(1,2,3,4,5,6,10,14,15,16),
  #                                    to = c("N", "NNE", "NE","ENE","E","ESE","SSW","WNW","NW","NNW")),levels=c("N", "NNE", "NE","ENE","E","ESE","SSW","WNW","NW","NNW"), order=TRUE))%>%
  # remove s3 because it's an outlier
  filter(!prod=="NA"&!is.na(pa_ratio),!subcol=="s3")%>%
  # Scale values to make model fitting easier
  mutate(prod_scale = (prod-mean(prod, na.rm=TRUE))/sd(prod, na.rm=TRUE),
         area_scale=scale(area),
         pa_scale=scale(pa_ratio),
         slope_scale=scale(mean_slope),
         aspect_scale=scale(mean_aspect),
         elev_scale=scale(adjust_mean_elev),
         wind_scale=scale(mean_wind),
         solar_scale=scale(mean_solar),
         flood_scale=scale(flood_risk),
         skua50=factor(skua50),
         skua100=factor(skua100),
         ln_flood=log(flood_risk+0.0001),
         flood_bin = ifelse(flood_risk>0,1,0),
         dens = active_ct/area)

sapply(dat,class)

pairs(dat[,c("prod","dens","area","pa_ratio","mean_slope","mean_aspect","adjust_mean_elev", "mean_wind", "mean_solar","flood_risk","skua50","skua100")],lower.panel = panel.smooth, upper.panel = panel.cor)

dat$ln_flood[dat$ln_flood=="-Inf"]<-min(dat$ln_flood)
hist(dat$dens)
range(dat$dens)
boxplot(dat$dens)

filter(dat,dens>4)

# filter data to only include subcolonies with counts all 4 years
all4 <- dat%>%
  select(subcol,prod)%>%
  group_by(subcol)%>%
  summarise(count=n())%>%
  filter(count==4)


dat4 <- dat%>%
  filter(subcol%in%all4$subcol)
```

Calculate correlation between productivity layer and bqi layer
```{r attempt raster correlation}
library(raster)

r <- raster("C:/Users/aschmidt/Dropbox/Antarctica/GIS/bs_habitat/croz_last_bqi_surface_ebk2.tif")
plot(r)
r2 <- raster("C:/Users/aschmidt/Dropbox/Antarctica/GIS/bs_habitat/croz_prod_surface_ebk.tif")
plot(r2)

rs <- stack(r,r2)


t <- read.csv("Z:/Informatics/S031/analyses/aschmidt/subcol_var/data/croz_2014_mean_bqi_prod_anom.txt")
library(Hmisc)
rcorr(t$MEAN,t$ann_prod_anom)

col_aspect <- raster("C:/Users/aschmidt/Dropbox/Antarctica/GIS/bs_habitat/croz_col_aspect.tif")
# reclassify raster to categories
# reclassification matrix, from, to and becomes
rcl_mat <- matrix(0,16,3)
rcl_mat[,1] <- c(0,22,45,67,90,112,135,157,180,202,225,247,270,292,315,337)
rcl_mat[,2]<- c(22,45,67,90,112,135,157,180,202,225,247,270,292,315,337,360)
rcl_mat[,3]<- c(1:16)

aspect_rcl <- reclassify(col_aspect,rcl_mat)

col_slope <- raster("C:/Users/aschmidt/Dropbox/Antarctica/GIS/bs_habitat/croz_col_slope4.tif")

col_elev <- raster("C:/Users/aschmidt/Dropbox/Antarctica/GIS/bs_habitat/croz_col_elev2.tif")

col_side <- raster("C:/Users/aschmidt/Dropbox/Antarctica/GIS/bs_habitat/croz_col_side_proj.tif")

# aspect_cat =findInterval(mean_aspect,c(0,22,45,67,90,112,135,157,180,202,225,247,270,292,315,337,360)))%>%
#   mutate(aspect_cat=factor(plyr::mapvalues(aspect_cat, from = c(1,2,3,4,5,6,10,14,15,16),
#                                      to = c("N", "NNE", "NE","ENE","E","ESE","SSW","WNW","NW","NNW"))))

croz_stack <- stack(col_slope, col_side)
croz_stack <- stack(croz_stack,col_side)
names(croz_stack)<-c("mean_slope", "mean_aspect", "mean_elev")
season <- factor('1516', levels=levels(dat$season))
c
add<- data.frame(season)

t <- findInterval(mean_aspect,c(0,22,45,67,90,112,135,157,180,202,225,247,270,292,315,337,360))

p <- predict(croz_stack,gam1,const=add, type="response")

plot(p)
writeRaster(p, "C:/Users/aschmidt/Dropbox/Antarctica/GIS/bs_habitat/croz_predict_prod.tif", format="GTiff")
names(dat)
sapply(dat,class)

t <- read.csv("Z:/Informatics/S031/analyses/aschmidt/subcol_var/data/croz_2014_predicted_mean_prod.txt", header=TRUE)
dat10 <- dat%>%
  dplyr::select(subcol,prod)

t <- rename(t,subcol_anom=SELECTED_SUBCOL_)
t2 <- left_join(t,subcol_anom,by="subcol")
Hmisc::rcorr(t2$MEAN,t2$ann_prod_anom)
```

Trying GAMs
```{r Trying GAMMs}
# both dist_beach highly correlated with elevation
# removed shade because highly correlated with slope
# removed solar because highly correlated with wind

# Starting with model with all variables of interest and season as fixed effect
k=10
# all models with random effect of subcol
# using REML based on recommendation in Marra and Wood 2011

# Model with just measured variables
gam_meas <- gam(prod~s(area, k=k, bs="cs")+s(pa_ratio, k=k, bs="cs")+s(mean_slope,k=k, bs="cs")+s(adjust_mean_elev,k=k, bs="cs")+s(mean_aspect, k=8,bs="cc")+skua50+season+s(subcol, bs="re"),data=dat, method = "REML")
plot.gam(gam_meas, pages=1, pch=19, cex=0.5, scale=0, shade=TRUE)
summary(gam_meas)
        
# Model with derived variables
gam_deriv <-  gam(prod~s(mean_wind,k=k, bs="cs")+s(mean_solar,k=k, bs="cs")+s(ln_flood, k=k, bs="cs")+season+ s(subcol, bs="re"),data=dat, method = "REML")
plot.gam(gam_deriv, residuals=TRUE, pages=1, pch=19, cex=0.5, scale=0)
summary(gam_deriv)     

# include both measured and derived  
gam_combined <- gam(prod~s(area, k=k, bs="cs")+s(pa_ratio, k=k, bs="cs")+s(mean_slope,k=k, bs="cs")+s(adjust_mean_elev,k=k, bs="cs")+s(mean_aspect, k=8,bs="cc")+s(mean_wind,k=k, bs="cs")+s(mean_solar,k=k, bs="cs")+s(flood_risk, k=k, bs="cs")+skua50+season+s(subcol, bs="re"),data=dat, method = "REML")
plot.gam(gam_combined, pages=1, pch=19, cex=0.5, shade=TRUE)
summary(gam_combined)  
  
concurv_comb<- concurvity(gam_combined, full=FALSE)

# Remove variables with >0.6 estimated concurvity (??)
# Slope and wind = 0.6395

# Don't think I should have aspect, wind, and solar in same model
# Use model selection for this?
gam_aspect <- gam(prod~s(area, k=k, bs="cs")+s(pa_ratio, k=k, bs="cs")+s(mean_slope,k=k, bs="cs")+s(adjust_mean_elev,k=k, bs="cs")+s(mean_aspect,k=10, bs="cc")+s(flood_risk, k=k, bs="cs")+skua50+season+s(subcol, bs="re"),data=dat, method = "REML")
plot.gam(gam_aspect, pages=1, shade=TRUE)
summary(gam_aspect)

gam_wind <- gam(prod~s(area, k=k, bs="cs")+s(pa_ratio, k=k, bs="cs")+s(mean_slope,k=k, bs="cs")+s(adjust_mean_elev,k=k, bs="cs")+s(mean_wind,k=k, bs="cs")+s(flood_risk, k=k, bs="cs")+skua50+season+s(subcol, bs="re"),data=dat, method = "REML")
summary(gam_wind)
plot.gam(gam_wind, pages=1, shade=TRUE)

gam_solar <- gam(prod~s(area, k=k, bs="cs")+s(pa_ratio, k=k, bs="cs")+s(mean_slope,k=k, bs="cs")+s(adjust_mean_elev,k=k, bs="cs")+s(mean_solar,k=k, bs="cs")+s(flood_risk, k=k, bs="cs")+skua50+season+s(subcol, bs="re"),data=dat, method = "REML")
summary(gam_solar)
plot.gam(gam_solar, pages=1, shade=TRUE)

gam_wind_solar <- gam(prod~s(area, k=k, bs="cs")+s(pa_ratio, k=k, bs="cs")+s(mean_slope,k=k, bs="cs")+s(adjust_mean_elev,k=k, bs="cs")+s(mean_solar,k=k, bs="cs")+s(mean_wind,k=k, bs="cs")+s(flood_risk, k=k, bs="cs")+skua50+season+s(subcol, bs="re"),data=dat, method = "REML")
summary(gam_wind_solar)
plot.gam(gam_wind_solar, pages=1, shade=TRUE)

# Model selection on these
AICctab(gam_aspect,gam_wind,gam_solar, gam_wind_solar,nobs=276, base=TRUE, weights=TRUE, logLik=TRUE)


# # remove wind
# gam_comb_slope<- gam(prod~s(area, k=k, bs="cs")+s(pa_ratio, k=k, bs="cs")+s(mean_slope,k=k, bs="cs")+s(adjust_mean_elev,k=k, bs="cs")+s(mean_aspect, k=8,bs="cc")+s(mean_solar,k=k, bs="cs")+s(flood_risk, k=k, bs="cs")+skua50+season+s(subcol, bs="re"),data=dat, method = "REML")
# plot.gam(gam_comb_slope, residuals=TRUE, pages=1, pch=19, cex=0.5, scale=0)
# summary(gam_comb_slope)  
# 
# # remove slope
# gam_comb_wind<- gam(prod~s(area, k=k, bs="cs")+s(pa_ratio, k=k, bs="cs")+s(mean_wind,k=k, bs="cs")+s(adjust_mean_elev,k=k, bs="cs")+s(mean_aspect, k=8,bs="cc")+s(mean_solar,k=k, bs="cs")+s(flood_risk, k=k, bs="cs")+skua50+season+s(subcol, bs="re"),data=dat, method = "REML")
# plot.gam(gam_comb_wind, residuals=TRUE, pages=1, pch=19, cex=0.5, scale=0)
# summary(gam_comb_wind) 
# 
gam_wind_simpl <- gam(prod~s(pa_ratio, k=k, bs="cs")+s(adjust_mean_elev,k=k, bs="cs")+s(mean_wind,k=8,bs="cs")+season+s(subcol, bs="re"),data=dat, method = "REML")
summary(gam_wind_simpl)
plot.gam(gam_wind_simpl, shade=TRUE, pages=1, scale=0)

# Remove vars with zero edf in combined model and add year interaction
gam_xseason <- gam(prod~s(pa_ratio,by=season, k=k, bs="cs")+s(adjust_mean_elev,by=season,k=k, bs="cs")+s(mean_wind, by=season,k=k, bs="cs")+season+s(subcol, bs="re"),data=dat, method = "REML")
plot.gam(gam_xseason, pages=1, pch=19, cex=0.5, shade=TRUE, scale=0)
summary(gam_xseason)  


AICctab(gam_xseason,gam_wind_simpl, nobs=276, base=TRUE, weights=TRUE, logLik=TRUE)
  
```
Trying BRT
```{r Trying BRT}
library(dismo)
gbm_test<-gbm.step(data=as.data.frame(dat),gbm.y=5,gbm.x=c("area", "pa_ratio", "mean_slope", "adjust_mean_elev", "mean_wind", "mean_aspect", "mean_solar", "flood_risk", "skua50", "season"),tree.complexity=5,learning.rate=0.0001,family="gaussian",max.trees=10000)
gbm.plot(gbm_test,smooth=TRUE, common.scale=FALSE)

All_interact <- gbm.interactions(gbmAll)




```
